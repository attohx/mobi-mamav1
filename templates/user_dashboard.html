{% extends "base.html" %}
{% block content %}

<div class="container py-4">
  <h2 class="fw-bold mb-4 text-center" style="color:var(--teal);">
    üë©üèΩ‚Äçüçº My Dashboard
  </h2>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Quick Stats Cards -->
  <div class="row mb-4 g-3">
    <div class="col-12 col-md-4">
      <div class="card text-center shadow-sm p-3">
        <h6>Total Tips Read</h6>
        <h4 class="fw-bold">{{ stats.total_tips_read }}</h4>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-center shadow-sm p-3">
        <h6>Total Appointments</h6>
        <h4 class="fw-bold">{{ stats.total_appointments }}</h4>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-center shadow-sm p-3">
        <h6>Next Appointment</h6>
        {% if stats.next_appointment %}
          <h5 class="fw-bold">{{ stats.next_appointment.date.strftime('%Y-%m-%d %H:%M') }}</h5>
          <p>{{ stats.next_appointment.clinic }}</p>
        {% else %}
          <p class="text-muted">No upcoming appointments</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Daily Tips Cards -->
  <h5 class="mb-3" style="color:var(--teal);">Daily Tips</h5>
  <input type="text" class="form-control mb-3" id="searchTips" placeholder="Search Tips..." onkeyup="filterTips()">

  {% if tips.items %}
  <div class="row g-3 mb-4" id="tipsCards">
    {% for tip in tips.items %}
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">{{ tip.title }}</h6>
          <p class="card-subtitle mb-2 text-muted">{{ tip.language|upper }} | {{ tip.created_at.strftime('%Y-%m-%d') }}</p>
          {% if tip.id in user_bookmarks %}
            <span class="badge bg-success">Bookmarked</span>
          {% else %}
            <a href="{{ url_for('bookmark_tip', tip_id=tip.id) }}" class="btn btn-sm btn-outline-primary mt-2">Bookmark</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-muted">No tips available yet.</p>
  {% endif %}

  <!-- Appointments Cards -->
  <h5 class="mb-3" style="color:var(--teal);">Appointments</h5>
  <a href="{{ url_for('book_appointment') }}" class="btn btn-coral btn-sm mb-2">+ Book Appointment</a>
  <input type="text" class="form-control mb-3" id="searchAppts" placeholder="Search Appointments..." onkeyup="filterAppts()">

  {% if appts.items %}
  <div class="row g-3" id="apptsCards">
    {% for appt in appts.items %}
    <div class="col-12 col-sm-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title">{{ appt.clinic }}</h6>
          <p class="card-text mb-1"><strong>Date:</strong> {{ appt.date }}</p>
          <p class="card-text mb-2"><strong>Status:</strong> 
            {% if appt.status == 'completed' %}
              <span class="badge bg-success">Completed</span>
            {% elif appt.status == 'pending' %}
              <span class="badge bg-warning text-dark">Pending</span>
            {% elif appt.status == 'canceled' %}
              <span class="badge bg-danger">Canceled</span>
            {% endif %}
          </p>
          {% if appt.status == 'pending' %}
            <a href="{{ url_for('cancel_appointment', appt_id=appt.id) }}" class="btn btn-sm btn-outline-danger">Cancel</a>
          {% else %}
            <span class="text-muted">N/A</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-muted">No appointments yet.</p>
  {% endif %}

</div>

<!-- JS for Card Search -->
<script>
function filterTips() {
  const input = document.getElementById('searchTips').value.toLowerCase();
  const cards = document.getElementById('tipsCards').getElementsByClassName('card');
  for (let card of cards) {
    card.parentElement.style.display = card.innerText.toLowerCase().includes(input) ? '' : 'none';
  }
}

function filterAppts() {
  const input = document.getElementById('searchAppts').value.toLowerCase();
  const cards = document.getElementById('apptsCards').getElementsByClassName('card');
  for (let card of cards) {
    card.parentElement.style.display = card.innerText.toLowerCase().includes(input) ? '' : 'none';
  }
}
</script>

{% endblock %}
